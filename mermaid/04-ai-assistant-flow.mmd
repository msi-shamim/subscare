%% ============================================================
%% SECTION 4: AI ASSISTANT DATA FLOW
%% ============================================================

flowchart TB
    subgraph AI["AI ASSISTANT FLOW"]
        direction TB

        A_START([User Taps AI FAB]) --> A_SHEET[Open Bottom Sheet]
        A_SHEET --> A_COMPOSER[Prompt Composer]

        A_COMPOSER --> A_INPUT{Input Method}

        A_INPUT -->|Type| A_TEXT[Text Input]
        A_INPUT -->|Voice| A_VOICE[Voice Input]
        A_INPUT -->|Suggestion| A_SUGGEST[Tap Suggestion]

        A_VOICE --> A_STT[Speech to Text]
        A_STT --> A_TEXT
        A_SUGGEST --> A_TEXT

        A_TEXT --> A_SEND[Send to Gemini]

        A_SEND --> A_API[Gemini 3.0 Flash API]
        A_API --> A_RESPONSE[Receive Response]

        A_RESPONSE --> A_PARSE[Parse AI Response]

        A_PARSE --> A_EXTRACT_TITLE[Extract Title]
        A_PARSE --> A_EXTRACT_AMT[Extract Amount]
        A_PARSE --> A_EXTRACT_TYPE[Extract Debit/Credit]
        A_PARSE --> A_EXTRACT_CAT[Suggest Category]
        A_PARSE --> A_EXTRACT_DATE[Extract Date]

        A_EXTRACT_TITLE --> A_PREVIEW[Show Parsed Preview]
        A_EXTRACT_AMT --> A_PREVIEW
        A_EXTRACT_TYPE --> A_PREVIEW
        A_EXTRACT_CAT --> A_PREVIEW
        A_EXTRACT_DATE --> A_PREVIEW

        A_PREVIEW --> A_CONFIRM{User Action}

        A_CONFIRM -->|Edit| A_EDIT[Edit Transaction Form]
        A_CONFIRM -->|Confirm| A_SAVE[Save Transaction]
        A_CONFIRM -->|Retry| A_COMPOSER
        A_CONFIRM -->|Cancel| A_CANCEL([Discard])

        A_EDIT --> A_SAVE

        %% Database Operations
        A_SAVE --> A_DB_HISTORY[(Hive: aiPromptHistory)]
        A_SAVE --> A_DB_TXN[(Hive: transactions)]

        %% Optional Attachment
        A_SAVE --> A_ATTACH{Add Reference?}
        A_ATTACH -->|Yes| A_PICK_DOC[Pick Document/Image]
        A_ATTACH -->|No| A_DONE[Complete]

        A_PICK_DOC --> A_DB_ATTACH[(Hive: attachments)]
        A_DB_ATTACH --> A_DONE

        %% Update Dashboard
        A_DB_TXN --> A_REFRESH[Refresh Dashboard]
        A_REFRESH --> A_LEDGER[Update Ledger View]
        A_REFRESH --> A_ANALYTICS[Update Analytics]

        A_DONE --> A_CLOSE[Close Bottom Sheet]
    end

    style AI fill:#EDE7F6,stroke:#512DA8
    style A_DB_HISTORY fill:#BBDEFB,stroke:#1976D2
    style A_DB_TXN fill:#BBDEFB,stroke:#1976D2
    style A_DB_ATTACH fill:#BBDEFB,stroke:#1976D2
    style A_API fill:#FFCDD2,stroke:#B71C1C
